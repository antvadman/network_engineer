# Lab 10 iBGP

Задачи лабораторной работы:  

1. Настроите iBGP в офисе Москва между маршрутизаторами R14 и R15.
2. Настроите iBGP в провайдере Триада, с использованием RR.
3. Настройте офиса Москва так, чтобы приоритетным провайдером стал Ламас.
4. Настройте офиса С.-Петербург так, чтобы трафик до любого офиса распределялся по двум линкам одновременно.
5. Все сети в лабораторной работе должны иметь IP связность.

### 1 Настроите iBGP в офисе Москва между маршрутизаторами R14 и R15.
<image src="scheme1.png">
В домен iBGP также включил роутеры R12, R13. Здесь классический full-mesh, на каждом линке поднимается соседство, протокол iBGP сходится. Для того, чтобы R12, R13 имели связность с next-hop, этот параметр подменяется на пограничных маршрутизаторах для каждого соседа.
Ниже приведена конфигурация для R15 (R14 - аналогично)
```
 neighbor 10.1.1.1 next-hop-self
 neighbor 101.0.0.2 next-hop-self
```
Так же на R12, R13 анонсированы сети:
```
router bgp 1001
 network 192.168.0.0
 network 192.168.1.0
```
### 2 Настроите iBGP в провайдере Триада, с использованием RR.
<image src="scheme2.png">
Роутеры R23, R24 сделал RouteReflector, роутеры R25,R26 соответственно сделал клиентами RR. Между R25 и R26 нет логической связи. Таким образом мы получили два кластера (в идеале в ценр схемы нужно поместить RR и поднять топологию "Звезда", здесь мне хотелось поработать с двумя кластерами в одной AS).
Ниже приведена конфигурация для R23.
Здесь мы задаем поднимаем соседство, задаем ID кластера, и описываем клиенов.
```
 bgp cluster-id 23
 neighbor 11.0.2.1 remote-as 101
 neighbor 13.0.0.2 remote-as 2222
 neighbor 13.0.0.2 route-reflector-client
 neighbor 13.0.0.2 next-hop-self
 neighbor 13.0.1.2 remote-as 2222
```
Ниже приведена конфигурация для R24.
```
 bgp cluster-id 24
 neighbor 12.0.1.1 remote-as 301
 neighbor 13.0.1.1 remote-as 2222
 neighbor 13.0.3.1 remote-as 2222
 neighbor 13.0.3.1 route-reflector-client
 neighbor 13.0.3.1 next-hop-self
 neighbor 14.0.4.1 remote-as 2042
```
### 3 Настройте офиса Москва так, чтобы приоритетным провайдером стал Ламас.
Трассировка до изменения приорета (трафик идет через Киторн):
```
R12#traceroute 23.23.23.23 source 12.12.12.12
Tracing the route to 23.23.23.23
VRF info: (vrf in name/id, vrf out name/id)
  1 10.0.0.2 1 msec 2 msec 1 msec
  2 11.0.0.1 2 msec 2 msec 2 msec
  3 11.0.2.2 1 msec 3 msec *
```
Далее меняем параметр Local preference:
```
bgp default local-preference 200
```
Теперь трафик пошел по неоптимальному маршруру через Ламас:
```
R12#traceroute 23.23.23.23 source 12.12.12.12
Tracing the route to 23.23.23.23
VRF info: (vrf in name/id, vrf out name/id)
  1 10.0.0.2 1 msec 2 msec 1 msec
  2 10.0.1.4 2 msec 2 msec 1 msec
  3 12.0.0.1 2 msec 2 msec 1 msec
  4 12.0.1.2 2 msec 2 msec 1 msec
  5 13.0.1.1 2 msec 3 msec *
```
### 4 Настройте офиса С.-Петербург так, чтобы трафик до любого офиса распределялся по двум линкам одновременно.
Для распределения использовалась следующая команда:
```
router bgp 2042
 maximum-paths 2
```
Для проверки запускаем пинг с VPC8 до офиса Москвы и пинг с VPC9 до Чокурдах. Смотрим дампы трафика на линках R18.
<image src="scheme3.png">

### 5. Все сети в лабораторной работе должны иметь IP связность.
Проверяем связность командой пинг.
МСК-Питер и Питер-Чокурдах - проверено в предыдущем пункте.
МСК - Чокурдах
```
VPCS> ping 192.168.30.11
84 bytes from 192.168.30.11 icmp_seq=1 ttl=57 time=1.355 ms
```
МСК - Лабытнаги
```
VPCS> ping 27.27.27.27
84 bytes from 27.27.27.27 icmp_seq=1 ttl=250 time=1.352 ms
```
Питер - Лабытнаги
```
VPCS> ping 27.27.27.27
84 bytes from 27.27.27.27 icmp_seq=1 ttl=250 time=1.352 ms
```
Чокурдах - МСК (R19)
```
VPCS> ping 19.19.19.19
84 bytes from 19.19.19.19 icmp_seq=1 ttl=249 time=1.446 ms
```
Чокурдах - Лабытнаги
```
VPCS> ping 27.27.27.27
84 bytes from 27.27.27.27 icmp_seq=1 ttl=252 time=0.859 ms
```
Лабытнаги - Питер
```
R27#ping 192.168.30.11 source 27.27.27.27
Type escape sequence to abort.
Sending 5, 100-byte ICMP Echos to 192.168.30.11, timeout is 2 seconds:
Packet sent with a source address of 27.27.27.27
!!!!!
Success rate is 100 percent (5/5), round-trip min/avg/max = 1/1/1 ms
```



